<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ©ãƒ³ãƒ‰ãƒ«ãƒˆç’°è¦–åŠ›æ¤œæŸ»</title>
<style>
  body {
    font-family: 'Comic Sans MS', sans-serif;
    margin:0; padding:0;
    text-align:center;
    background: linear-gradient(135deg, #cce7ff, #f0f4f8);
  }
  h1 {
    font-size: 2.2em;
    text-shadow: 2px 2px 5px #888;
    margin: 20px 0;
    color:#ff6b81;
  }
  button {
    font-size: 1.3em;
    padding: 18px 28px;
    margin: 10px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    color: white;
    box-shadow: 0 5px 10px rgba(0,0,0,0.3);
    transition: all 0.2s ease;
  }
  button:hover, button:active {
    transform: translateY(-2px);
    box-shadow: 0 8px 12px rgba(0,0,0,0.4);
  }
  button.blue { background: #3b82f6; }
  button.green { background: #22c55e; }
  button.orange { background: #f97316; }

  #scoreBarContainer {
    width: 90%;
    height: 25px;
    background: #eee;
    margin: 15px auto;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: inset 0 0 5px #aaa;
  }
  #scoreBar {
    width:0%;
    height:100%;
    border-radius: 15px;
    transition: width 0.3s ease-in-out, background 0.3s ease-in-out;
  }

  #gameArea {
    display:none;
    width:90%;
    height:50vh;
    margin:10px auto;
    background:white;
    border-radius:15px;
    box-shadow:0 5px 15px rgba(0,0,0,0.3);
    position:relative;
    overflow:hidden;
  }

  #resultScreen, #rankingScreen {
    display:none;
    background: #fff8dc;
    padding: 15px;
    border-radius: 15px;
    margin: 10px auto;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }


  .landolt {
    margin: 20px auto;
    position: relative;
    display: inline-block;
  }

  .gap {
    position: absolute;
    background: white;
  }

  #backgroundCanvas {
    position: fixed;
    top: 0;
    left: 0;
    z-index: -1;
    pointer-events: none;
  }

  .direction-buttons {
    margin-top: 20px;
  }

  .direction-buttons button {
    margin: 5px;
    padding: 12px 20px;
    font-size: 1.1em;
  }


  .flash {
    animation: flash 0.3s ease-in-out;
  }

  @keyframes flash {
    0%, 100% { background-color: inherit; }
    50% { background-color: #ffff00; }
  }
</style>
</head>
<body>

<h1>ãƒ©ãƒ³ãƒ‰ãƒ«ãƒˆç’°è¦–åŠ›æ¤œæŸ»</h1>

<div id="startScreen">
  <button class="blue" onclick="showRules()">è¦–åŠ›æ¤œæŸ»ã‚’é–‹å§‹</button>
</div>

<div id="rulesScreen" style="display:none; background: #fff8dc; padding: 20px; border-radius: 15px; margin: 10px auto; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-width: 500px;">
  <h2>ğŸ“± è¦–åŠ›æ¤œæŸ»ã®æ–¹æ³•</h2>
  <div style="text-align: left; font-size: 1.1em; line-height: 1.6;">
    <p><strong>ğŸ“ è·é›¢ã®è¨­å®šï¼š</strong></p>
    <ul>
      <li>ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚’ç›®ã‹ã‚‰ <strong>30cm</strong> é›¢ã—ã¦ãã ã•ã„</li>
      <li>ç”»é¢ã‚’å‚ç›´ã«ä¿ã¡ã€æ˜ã‚‹ã„å ´æ‰€ã§æ¸¬å®šã—ã¦ãã ã•ã„</li>
    </ul>
    
    <p><strong>ğŸ¯ æ¸¬å®šæ–¹æ³•ï¼š</strong></p>
    <ul>
      <li>ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹ã€ŒCã€ã®å½¢ï¼ˆãƒ©ãƒ³ãƒ‰ãƒ«ãƒˆç’°ï¼‰ã®åˆ‡ã‚Œç›®ã®æ–¹å‘ã‚’ç­”ãˆã¦ãã ã•ã„</li>
      <li>ä¸Šä¸‹å·¦å³ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦å›ç­”ã—ã¾ã™</li>
      <li>æ­£è§£ã™ã‚‹ã¨ç’°ãŒå°ã•ããªã‚Šã€ä¸æ­£è§£ã ã¨å¤§ãããªã‚Šã¾ã™</li>
      <li>è¦‹ãˆãªããªã‚‹ã¾ã§ç¶šã‘ã¦ã€ã‚ãªãŸã®è¦–åŠ›ã‚’æ¸¬å®šã—ã¾ã™</li>
    </ul>
    
    <p><strong>âš ï¸ æ³¨æ„äº‹é …ï¼š</strong></p>
    <ul>
      <li>ç‰‡ç›®ãšã¤æ¸¬å®šã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™</li>
      <li>ã“ã®çµæœã¯ç›®å®‰ã§ã™ã€‚æ­£ç¢ºãªè¦–åŠ›ã¯çœ¼ç§‘ã§æ¸¬å®šã—ã¦ãã ã•ã„</li>
    </ul>
  </div>
  
  <button class="blue" onclick="startLandolt()" style="margin-top: 20px;">ç†è§£ã—ã¾ã—ãŸ - é–‹å§‹</button>
</div>

<div id="scoreBarContainer">
  <div id="scoreBar"></div>
</div>

<div id="gameArea">
  <div class="direction-buttons">
    <button class="blue" onclick="answer('up')">ä¸Š</button><br>
    <button class="blue" onclick="answer('left')">å·¦</button>
    <button class="blue" onclick="answer('right')">å³</button><br>
    <button class="blue" onclick="answer('down')">ä¸‹</button>
  </div>
</div>


<div id="resultScreen">
  <h2>çµæœ</h2>
  <div id="resultText"></div>
  <button class="blue" onclick="saveAndShowRanking()">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹</button>
  <button class="green" onclick="location.reload()">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
</div>

<div id="rankingScreen">
  <h2>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
  <p id="rankingList"></p>
  <button onclick="location.reload()">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
</div>

<canvas id="backgroundCanvas"></canvas>

<script>
/* ===== èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ===== */
const canvas = document.getElementById('backgroundCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
let circles = [];
for(let i=0;i<30;i++){
  circles.push({
    x: Math.random()*canvas.width,
    y: Math.random()*canvas.height,
    r: Math.random()*20 + 5,
    dx: (Math.random()-0.5)*0.5,
    dy: (Math.random()-0.5)*0.5,
    alpha: Math.random()*0.5+0.3
  });
}
function animateBackground(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  circles.forEach(c=>{
    ctx.beginPath();
    ctx.arc(c.x, c.y, c.r, 0, Math.PI*2);
    ctx.fillStyle = `rgba(100,150,255,${c.alpha})`;
    ctx.fill();
    c.x += c.dx; c.y += c.dy;
    if(c.x<0||c.x>canvas.width) c.dx*=-1;
    if(c.y<0||c.y>canvas.height) c.dy*=-1;
  });
  requestAnimationFrame(animateBackground);
}
animateBackground();

/* ===== åŠ¹æœéŸ³ï¼ˆãƒ€ãƒŸãƒ¼é–¢æ•°ï¼‰ ===== */
function playSound(type) {
  // åŠ¹æœéŸ³ã®ä»£ã‚ã‚Šã«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°
  console.log(`Playing ${type} sound`);
}

/* ===== å¤‰æ•° ===== */
let size=100, minSize=4, currentDir, attempts=0, correctCount=0;
let gameMode = 'landolt';

/* ===== ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ ===== */
function startCountdown(callback){
  let overlay = document.createElement('div');
  overlay.style.position = 'fixed';
  overlay.style.top = 0;
  overlay.style.left = 0;
  overlay.style.width = '100%';
  overlay.style.height = '100%';
  overlay.style.background = 'rgba(0,0,0,0.7)';
  overlay.style.display = 'flex';
  overlay.style.justifyContent = 'center';
  overlay.style.alignItems = 'center';
  overlay.style.zIndex = 9999;
  overlay.style.color = 'white';
  overlay.style.fontSize = '5em';
  document.body.appendChild(overlay);
  let count = 3;
  overlay.innerText = count;
  let timer = setInterval(()=>{
    count--;
    if(count > 0) overlay.innerText = count;
    else if(count === 0) overlay.innerText = "ã‚¹ã‚¿ãƒ¼ãƒˆï¼";
    else { clearInterval(timer); document.body.removeChild(overlay); callback(); }
  },1000);
}

/* ===== ã‚¹ã‚³ã‚¢ãƒãƒ¼ ===== */
function updateScoreBar(){
  let percent = ((100-size)/96)*100;
  percent = Math.min(100, Math.max(0, percent));
  let bar = document.getElementById('scoreBar');
  bar.style.background='#3b82f6';
  bar.style.width = percent+'%';
}

function flashScoreBar() {
  let bar = document.getElementById('scoreBar');
  bar.classList.add('flash');
  setTimeout(() => bar.classList.remove('flash'), 300);
}

/* ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚° ===== */
function saveScore(mode, score){
  let name = prompt("ã‚¹ã‚³ã‚¢ã‚’ä¿å­˜ã™ã‚‹åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„","åç„¡ã—");
  if(!name) name="åç„¡ã—";
  let key="ranking_"+mode;
  let ranking = JSON.parse(localStorage.getItem(key)||"[]");
  ranking.push({name,score});
  ranking.sort((a,b)=>b.score-a.score);
  ranking = ranking.slice(0,5);
  localStorage.setItem(key, JSON.stringify(ranking));
}

function showRanking(mode){
  document.getElementById('resultScreen').style.display='none';
  document.getElementById('rankingScreen').style.display='block';
  let key="ranking_"+mode;
  let ranking = JSON.parse(localStorage.getItem(key)||"[]");
  let html = ranking.map((r,i)=> `${i+1}ä½: ${r.name} - è¦–åŠ›${r.score}`).join("<br>");
  document.getElementById('rankingList').innerHTML = html||"ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“";
}

function saveAndShowRanking() {
  let vision = calculateVision();
  saveScore('landolt', vision);
  showRanking('landolt');
}

function calculateScore() {
  return Math.max(0, 100 - size);
}

function calculateVision() {
  // è¦–åŠ›è¨ˆç®—: ã‚µã‚¤ã‚ºãŒå°ã•ã„ã»ã©è‰¯ã„è¦–åŠ›
  if(size <= 4) return 5.0;
  else if(size <= 6) return 3.0;
  else if(size <= 8) return 2.5;
  else if(size <= 10) return 2.0;
  else if(size <= 12) return 1.5;
  else if(size <= 16) return 1.2;
  else if(size <= 20) return 1.0;
  else if(size <= 25) return 0.9;
  else if(size <= 30) return 0.8;
  else if(size <= 40) return 0.7;
  else if(size <= 50) return 0.6;
  else if(size <= 60) return 0.5;
  else if(size <= 70) return 0.4;
  else if(size <= 80) return 0.3;
  else if(size <= 90) return 0.2;
  else return 0.1;
}

/* ===== ã‚²ãƒ¼ãƒ é–‹å§‹ ===== */
function showRules(){
  document.getElementById('startScreen').style.display='none';
  document.getElementById('rulesScreen').style.display='block';
}

function startLandolt(){
  document.getElementById('rulesScreen').style.display='none';
  startCountdown(()=>{
    document.getElementById('gameArea').style.display='block';
    size=100; correctCount=0; attempts=0;
    nextRound();
  });
}

/* ===== ãƒ©ãƒ³ãƒ‰ãƒ«ãƒˆç’° ===== */
let directions = ["up","down","left","right"];

function drawLandolt(s, dir){
  let area = document.getElementById('gameArea');
  let existingLandolt = area.querySelector('.landolt');
  if(existingLandolt) existingLandolt.remove();
  
  // SVGã§ãƒ©ãƒ³ãƒ‰ãƒ«ãƒˆç’°ã‚’æç”»
  let svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.className = 'landolt';
  svg.setAttribute('width', s);
  svg.setAttribute('height', s);
  svg.style.margin = '20px auto';
  svg.style.display = 'block';
  
  let circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  circle.setAttribute('cx', s/2);
  circle.setAttribute('cy', s/2);
  circle.setAttribute('r', (s-20)/2);
  circle.setAttribute('fill', 'none');
  circle.setAttribute('stroke', 'black');
  circle.setAttribute('stroke-width', '10');
  
  // åˆ‡ã‚Œç›®ã‚’ä½œã‚‹ãŸã‚ã®ãƒ‘ã‚¹
  let gapSize = s/5; // åˆ‡ã‚Œç›®ã®ã‚µã‚¤ã‚º
  let radius = (s-20)/2;
  let centerX = s/2;
  let centerY = s/2;
  
  let path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('fill', 'none');
  path.setAttribute('stroke', 'black');
  path.setAttribute('stroke-width', '10');
  path.setAttribute('stroke-linecap', 'butt');
  
  let pathData = '';
  
  if(dir === 'up') {
    // ä¸Šã®åˆ‡ã‚Œç›®
    let angle1 = -gapSize/radius;
    let angle2 = Math.PI * 2 + gapSize/radius;
    pathData = `M ${centerX + radius * Math.cos(angle1)} ${centerY + radius * Math.sin(angle1)} A ${radius} ${radius} 0 1 1 ${centerX + radius * Math.cos(angle2)} ${centerY + radius * Math.sin(angle2)}`;
  } else if(dir === 'down') {
    // ä¸‹ã®åˆ‡ã‚Œç›®  
    let angle1 = Math.PI - gapSize/radius;
    let angle2 = Math.PI + gapSize/radius;
    pathData = `M ${centerX + radius * Math.cos(angle1)} ${centerY + radius * Math.sin(angle1)} A ${radius} ${radius} 0 1 1 ${centerX + radius * Math.cos(angle2)} ${centerY + radius * Math.sin(angle2)}`;
  } else if(dir === 'left') {
    // å·¦ã®åˆ‡ã‚Œç›®
    let angle1 = Math.PI/2 + gapSize/radius;
    let angle2 = Math.PI*3/2 - gapSize/radius;
    pathData = `M ${centerX + radius * Math.cos(angle1)} ${centerY + radius * Math.sin(angle1)} A ${radius} ${radius} 0 1 1 ${centerX + radius * Math.cos(angle2)} ${centerY + radius * Math.sin(angle2)}`;
  } else if(dir === 'right') {
    // å³ã®åˆ‡ã‚Œç›®
    let angle1 = -Math.PI/2 + gapSize/radius;
    let angle2 = Math.PI/2 - gapSize/radius;
    pathData = `M ${centerX + radius * Math.cos(angle1)} ${centerY + radius * Math.sin(angle1)} A ${radius} ${radius} 0 1 1 ${centerX + radius * Math.cos(angle2)} ${centerY + radius * Math.sin(angle2)}`;
  }
  
  path.setAttribute('d', pathData);
  
  svg.appendChild(path);
  area.insertBefore(svg, area.firstChild);
}

/* ===== ãƒ©ãƒ³ãƒ‰ãƒ«ãƒˆå›ç­” ===== */
function answer(dir){
  attempts++;
  if(dir===currentDir){
    correctCount++;
    playSound('correct');
    flashScoreBar();
    size=Math.max(minSize,size-2);
  } else {
    playSound('wrong');
    size=Math.min(100,size+3);
  }
  updateScoreBar();
  if(size<=minSize||attempts>=30) endGame();
  else nextRound();
}

function nextRound(){
  currentDir = directions[Math.floor(Math.random()*4)];
  drawLandolt(size,currentDir);
  updateScoreBar();
}


/* ===== çµæœ ===== */
function endGame(){
  document.getElementById('gameArea').style.display='none';
  document.getElementById('resultScreen').style.display='block';
  
  let vision = calculateVision();
  let score = calculateScore();
  let result;
  
  if(vision >= 2.0) result = `è¦–åŠ›${vision}ï¼ç´ æ™´ã‚‰ã—ã„è¦–åŠ›ã§ã™ï¼`;
  else if(vision >= 1.0) result = `è¦–åŠ›${vision}ï¼è‰¯å¥½ãªè¦–åŠ›ã§ã™ï¼`;
  else if(vision >= 0.7) result = `è¦–åŠ›${vision}ã€‚æ—¥å¸¸ç”Ÿæ´»ã«æ”¯éšœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`;
  else if(vision >= 0.3) result = `è¦–åŠ›${vision}ã€‚ã‚„ã‚„æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚`;
  else result = `è¦–åŠ›${vision}ã€‚çœ¼ç§‘å—è¨ºã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚`;
  
  document.getElementById('resultText').innerHTML = 
    `<h3>æ¸¬å®šçµæœ</h3><p style="font-size:1.5em;color:#ff6b81;"><strong>${result}</strong></p><p>ã‚¹ã‚³ã‚¢: ${score}ç‚¹</p><p>æ­£è§£æ•°: ${correctCount}å› / ${attempts}å›</p><p><small>â€»ã“ã®çµæœã¯ç›®å®‰ã§ã™ã€‚æ­£ç¢ºãªè¦–åŠ›ã¯çœ¼ç§‘ã§æ¸¬å®šã—ã¦ãã ã•ã„ã€‚</small></p>`;
}


// ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã«ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’èª¿æ•´
window.addEventListener('resize', function() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});
</script>
</body>
</html>
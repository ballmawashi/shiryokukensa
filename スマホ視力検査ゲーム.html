<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>スマホ視力検査ゲーム</title>
<style>
  body {
    font-family: 'Comic Sans MS', sans-serif;
    margin:0; padding:0;
    text-align:center;
    background: linear-gradient(135deg, #cce7ff, #f0f4f8);
  }
  h1 {
    font-size: 2.2em;
    text-shadow: 2px 2px 5px #888;
    margin: 20px 0;
    color:#ff6b81;
  }
  button {
    font-size: 1.3em;
    padding: 18px 28px;
    margin: 10px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    color: white;
    box-shadow: 0 5px 10px rgba(0,0,0,0.3);
    transition: all 0.2s ease;
  }
  button:hover, button:active {
    transform: translateY(-2px);
    box-shadow: 0 8px 12px rgba(0,0,0,0.4);
  }
  button.blue { background: #3b82f6; }
  button.green { background: #22c55e; }
  button.orange { background: #f97316; }

  #scoreBarContainer {
    width: 90%;
    height: 25px;
    background: #eee;
    margin: 15px auto;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: inset 0 0 5px #aaa;
  }
  #scoreBar {
    width:0%;
    height:100%;
    border-radius: 15px;
    transition: width 0.3s ease-in-out, background 0.3s ease-in-out;
  }

  #charArea, #gameArea, #colorTestArea {
    display:none;
    width:90%;
    height:50vh;
    margin:10px auto;
    background:white;
    border-radius:15px;
    box-shadow:0 5px 15px rgba(0,0,0,0.3);
    position:relative;
    overflow:hidden;
  }

  #resultScreen, #rankingScreen {
    display:none;
    background: #fff8dc;
    padding: 15px;
    border-radius: 15px;
    margin: 10px auto;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }

  .character {
    position: absolute;
    cursor: pointer;
  }

  .landolt {
    border: 8px solid black;
    border-radius: 50%;
    margin: 20px auto;
    position: relative;
  }

  .gap {
    position: absolute;
    background: white;
  }

  #backgroundCanvas {
    position: fixed;
    top: 0;
    left: 0;
    z-index: -1;
    pointer-events: none;
  }

  .direction-buttons {
    margin-top: 20px;
  }

  .direction-buttons button {
    margin: 5px;
    padding: 12px 20px;
    font-size: 1.1em;
  }

  .color-test-image {
    width: 200px;
    height: 200px;
    margin: 20px auto;
    border-radius: 10px;
    background: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3em;
    font-weight: bold;
  }

  .flash {
    animation: flash 0.3s ease-in-out;
  }

  @keyframes flash {
    0%, 100% { background-color: inherit; }
    50% { background-color: #ffff00; }
  }
</style>
</head>
<body>

<h1>スマホ視力検査ゲーム</h1>

<div id="startScreen">
  <button class="blue" onclick="startLandolt()">ランドルト環モード</button>
  <button class="green" onclick="startCharGame()">キャラクター探しモード</button>
  <button class="orange" onclick="startColorTest()">色覚テストモード</button>
</div>

<div id="scoreBarContainer">
  <div id="scoreBar"></div>
</div>

<div id="gameArea">
  <div class="direction-buttons">
    <button class="blue" onclick="answer('up')">上</button><br>
    <button class="blue" onclick="answer('left')">左</button>
    <button class="blue" onclick="answer('right')">右</button><br>
    <button class="blue" onclick="answer('down')">下</button>
  </div>
</div>

<div id="charArea"></div>

<div id="colorTestArea">
  <div class="color-test-image" id="colorTestImage"></div>
  <div>
    <input type="text" id="colorInput" placeholder="見える数字を入力" maxlength="3">
    <button class="orange" onclick="submitColorAnswer()">回答</button>
  </div>
</div>

<div id="resultScreen">
  <h2>結果</h2>
  <div id="resultText"></div>
  <button class="blue" onclick="saveAndShowRanking()">ランキングを見る</button>
  <button class="green" onclick="location.reload()">もう一度プレイ</button>
</div>

<div id="rankingScreen">
  <h2>ランキング</h2>
  <p id="rankingList"></p>
  <button onclick="location.reload()">トップに戻る</button>
</div>

<canvas id="backgroundCanvas"></canvas>

<script>
/* ===== 背景アニメーション ===== */
const canvas = document.getElementById('backgroundCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
let circles = [];
for(let i=0;i<30;i++){
  circles.push({
    x: Math.random()*canvas.width,
    y: Math.random()*canvas.height,
    r: Math.random()*20 + 5,
    dx: (Math.random()-0.5)*0.5,
    dy: (Math.random()-0.5)*0.5,
    alpha: Math.random()*0.5+0.3
  });
}
function animateBackground(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  circles.forEach(c=>{
    ctx.beginPath();
    ctx.arc(c.x, c.y, c.r, 0, Math.PI*2);
    ctx.fillStyle = `rgba(100,150,255,${c.alpha})`;
    ctx.fill();
    c.x += c.dx; c.y += c.dy;
    if(c.x<0||c.x>canvas.width) c.dx*=-1;
    if(c.y<0||c.y>canvas.height) c.dy*=-1;
  });
  requestAnimationFrame(animateBackground);
}
animateBackground();

/* ===== 効果音（ダミー関数） ===== */
function playSound(type) {
  // 効果音の代わりにコンソールログ
  console.log(`Playing ${type} sound`);
}

/* ===== 変数 ===== */
let size=80, minSize=10, currentDir, attempts=0, correctCount=0;
let charSize=50, charAttempts=0;
let colorTests = [
  {image: "12", answer: "12"},
  {image: "8", answer: "8"},
  {image: "29", answer: "29"},
  {image: "74", answer: "74"},
  {image: "3", answer: "3"}
];
let currentTestIndex=0;
let gameMode = '';

/* ===== カウントダウン ===== */
function startCountdown(callback){
  let overlay = document.createElement('div');
  overlay.style.position = 'fixed';
  overlay.style.top = 0;
  overlay.style.left = 0;
  overlay.style.width = '100%';
  overlay.style.height = '100%';
  overlay.style.background = 'rgba(0,0,0,0.7)';
  overlay.style.display = 'flex';
  overlay.style.justifyContent = 'center';
  overlay.style.alignItems = 'center';
  overlay.style.zIndex = 9999;
  overlay.style.color = 'white';
  overlay.style.fontSize = '5em';
  document.body.appendChild(overlay);
  let count = 3;
  overlay.innerText = count;
  let timer = setInterval(()=>{
    count--;
    if(count > 0) overlay.innerText = count;
    else if(count === 0) overlay.innerText = "スタート！";
    else { clearInterval(timer); document.body.removeChild(overlay); callback(); }
  },1000);
}

/* ===== スコアバー ===== */
function updateScoreBar(mode){
  let percent=0;
  if(mode==='landolt') percent = ((100-size)/90)*100;
  else if(mode==='char') percent = ((50-charSize)/40)*100;
  else if(mode==='color') percent = (correctCount/colorTests.length)*100;
  percent = Math.min(100, Math.max(0, percent));
  let bar = document.getElementById('scoreBar');
  if(mode==='landolt') bar.style.background='#3b82f6';
  else if(mode==='char') bar.style.background='#22c55e';
  else bar.style.background='#f97316';
  bar.style.width = percent+'%';
}

function flashScoreBar() {
  let bar = document.getElementById('scoreBar');
  bar.classList.add('flash');
  setTimeout(() => bar.classList.remove('flash'), 300);
}

/* ===== ランキング ===== */
function saveScore(mode, score){
  let name = prompt("スコアを保存する名前を入力してください","名無し");
  if(!name) name="名無し";
  let key="ranking_"+mode;
  let ranking = JSON.parse(localStorage.getItem(key)||"[]");
  ranking.push({name,score});
  ranking.sort((a,b)=>b.score-a.score);
  ranking = ranking.slice(0,5);
  localStorage.setItem(key, JSON.stringify(ranking));
}

function showRanking(mode){
  document.getElementById('resultScreen').style.display='none';
  document.getElementById('rankingScreen').style.display='block';
  let key="ranking_"+mode;
  let ranking = JSON.parse(localStorage.getItem(key)||"[]");
  let html = ranking.map((r,i)=> `${i+1}位: ${r.name} - ${r.score}点`).join("<br>");
  document.getElementById('rankingList').innerHTML = html||"まだ記録がありません";
}

function saveAndShowRanking() {
  let score = calculateScore();
  saveScore(gameMode, score);
  showRanking(gameMode);
}

function calculateScore() {
  if(gameMode === 'landolt') return Math.max(0, 100 - size);
  else if(gameMode === 'char') return Math.max(0, 50 - charSize) * 2;
  else if(gameMode === 'color') return correctCount * 20;
  return 0;
}

/* ===== ゲーム開始 ===== */
function startLandolt(){
  gameMode = 'landolt';
  document.getElementById('startScreen').style.display='none';
  startCountdown(()=>{
    document.getElementById('gameArea').style.display='block';
    size=80; correctCount=0; attempts=0;
    nextRound();
  });
}

function startCharGame(){
  gameMode = 'char';
  document.getElementById('startScreen').style.display='none';
  startCountdown(()=>{
    document.getElementById('charArea').style.display='block';
    charSize=50; charAttempts=0; correctCount=0;
    showCharacter();
  });
}

function startColorTest(){
  gameMode = 'color';
  document.getElementById('startScreen').style.display='none';
  startCountdown(()=>{
    document.getElementById('colorTestArea').style.display='block';
    currentTestIndex=0; correctCount=0;
    showColorTest();
  });
}

/* ===== ランドルト環 ===== */
let directions = ["up","down","left","right"];

function drawLandolt(s, dir){
  let area = document.getElementById('gameArea');
  let existingLandolt = area.querySelector('.landolt');
  if(existingLandolt) existingLandolt.remove();
  
  let c = document.createElement('div');
  c.className='landolt';
  c.style.width=s+'px'; 
  c.style.height=s+'px';
  c.style.margin='20px auto';
  c.style.position='relative';
  c.style.border = '8px solid black';
  c.style.borderRadius = '50%';
  
  let gap = document.createElement('div'); 
  gap.className='gap';
  gap.style.width=(s/4)+'px'; 
  gap.style.height=(s/4)+'px';
  gap.style.background='white';
  gap.style.position='absolute';
  
  if(dir==='up'){ gap.style.left=(s-s/4)/2+'px'; gap.style.top='-4px'; }
  else if(dir==='down'){ gap.style.left=(s-s/4)/2+'px'; gap.style.bottom='-4px'; }
  else if(dir==='left'){ gap.style.left='-4px'; gap.style.top=(s-s/4)/2+'px'; }
  else if(dir==='right'){ gap.style.right='-4px'; gap.style.top=(s-s/4)/2+'px'; }
  
  c.appendChild(gap);
  area.insertBefore(c, area.firstChild);
}

/* ===== ランドルト回答 ===== */
function answer(dir){
  attempts++;
  if(dir===currentDir){
    correctCount++;
    playSound('correct');
    flashScoreBar();
    size=Math.max(minSize,size-5);
  } else {
    playSound('wrong');
    size=Math.min(100,size+5);
  }
  updateScoreBar('landolt');
  if(size<=minSize||attempts>=20) endGame('landolt');
  else nextRound();
}

function nextRound(){
  currentDir = directions[Math.floor(Math.random()*4)];
  drawLandolt(size,currentDir);
  updateScoreBar('landolt');
}

/* ===== キャラ探し ===== */
function showCharacter(){
  let area = document.getElementById('charArea');
  area.innerHTML='';
  let char = document.createElement('div');
  char.innerHTML = '🎯';
  char.className='character';
  char.style.fontSize = charSize+'px';
  char.style.cursor = 'pointer';
  let maxX = area.clientWidth-charSize;
  let maxY = area.clientHeight-charSize;
  char.style.left=Math.random()*maxX+'px';
  char.style.top=Math.random()*maxY+'px';
  char.onclick=function(){
    playSound('click');
    showPopEffect(char.offsetLeft+charSize/2,char.offsetTop+charSize/2);
    correctCount++;
    charSize=Math.max(10,charSize-3);
    charAttempts++;
    updateScoreBar('char');
    if(charSize<=10 || charAttempts>=15) endGame('char');
    else showCharacter();
  };
  area.appendChild(char);
}

/* ===== キャラ弾けエフェクト ===== */
function showPopEffect(x,y){
  let pop=document.createElement('div');
  pop.style.position='absolute';
  pop.style.left=x+'px';
  pop.style.top=y+'px';
  pop.style.width='20px';
  pop.style.height='20px';
  pop.style.borderRadius='50%';
  pop.style.background='rgba(255,200,0,0.8)';
  pop.style.pointerEvents='none';
  pop.style.zIndex='1000';
  document.body.appendChild(pop);
  let start=Date.now();
  let anim=setInterval(()=>{
    let t=(Date.now()-start)/500;
    if(t>=1){ clearInterval(anim); document.body.removeChild(pop); return; }
    pop.style.transform=`scale(${1+t*2})`;
    pop.style.opacity=`${1-t}`;
  },16);
}

/* ===== 色覚テスト ===== */
function showColorTest(){
  if(currentTestIndex>=colorTests.length){ endGame('color'); return; }
  
  let imageDiv = document.getElementById('colorTestImage');
  let test = colorTests[currentTestIndex];
  
  // 簡単な色覚テスト画像をシミュレート
  imageDiv.innerHTML = '';
  imageDiv.style.background = getColorTestPattern(test.image);
  imageDiv.style.color = getTextColor(test.image);
  imageDiv.innerHTML = test.image;
  
  document.getElementById('colorInput').value = '';
}

function getColorTestPattern(num) {
  // 数字に応じて異なる色パターンを返す
  const patterns = {
    '12': 'radial-gradient(circle, #ff6b6b 30%, #4ecdc4 70%)',
    '8': 'radial-gradient(circle, #45b7d1 30%, #96ceb4 70%)',
    '29': 'radial-gradient(circle, #feca57 30%, #ff9ff3 70%)',
    '74': 'radial-gradient(circle, #54a0ff 30%, #5f27cd 70%)',
    '3': 'radial-gradient(circle, #00d2d3 30%, #ff9f43 70%)'
  };
  return patterns[num] || '#f0f0f0';
}

function getTextColor(num) {
  // 数字に応じてテキストの色を設定
  const colors = {
    '12': '#2d3436',
    '8': '#2d3436', 
    '29': '#2d3436',
    '74': '#ddd',
    '3': '#2d3436'
  };
  return colors[num] || '#000';
}

function submitColorAnswer(){
  let userAnswer = document.getElementById('colorInput').value;
  let correctAnswer = colorTests[currentTestIndex].answer;
  
  if(userAnswer === correctAnswer) {
    correctCount++;
    playSound('correct');
    flashScoreBar();
  } else {
    playSound('wrong');
  }
  
  currentTestIndex++;
  updateScoreBar('color');
  
  if(currentTestIndex < colorTests.length) {
    setTimeout(showColorTest, 1000);
  } else {
    endGame('color');
  }
}

/* ===== 結果 ===== */
function endGame(mode){
  document.getElementById('gameArea').style.display='none';
  document.getElementById('charArea').style.display='none';
  document.getElementById('colorTestArea').style.display='none';
  document.getElementById('resultScreen').style.display='block';
  
  let result, score;
  if(mode==='landolt'){
    score = Math.max(0, 100 - size);
    if(size <= 20) result = "視力1.0以上！素晴らしい！";
    else if(size <= 40) result = "視力0.7程度。良好です！";
    else if(size <= 60) result = "視力0.5程度。まずまずです。";
    else result = "視力0.3以下。眼科受診をおすすめします。";
  } else if(mode==='char'){
    score = Math.max(0, 50 - charSize) * 2;
    if(charSize <= 15) result = "動体視力抜群！";
    else if(charSize <= 25) result = "動体視力良好！";
    else if(charSize <= 35) result = "動体視力普通です。";
    else result = "動体視力要改善。";
  } else if(mode==='color'){
    score = correctCount * 20;
    if(correctCount === colorTests.length) result = "色覚完璧！";
    else if(correctCount >= colorTests.length * 0.8) result = "色覚良好！";
    else if(correctCount >= colorTests.length * 0.6) result = "色覚普通です。";
    else result = "色覚に課題があるかもしれません。";
  }
  
  document.getElementById('resultText').innerHTML = 
    `<h3>${result}</h3><p>スコア: ${score}点</p><p>正解数: ${correctCount}回</p>`;
}

// エンターキーで色覚テストの回答を送信
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('colorInput').addEventListener('keypress', function(e) {
    if(e.key === 'Enter') {
      submitColorAnswer();
    }
  });
});

// ウィンドウリサイズ時にキャンバスサイズを調整
window.addEventListener('resize', function() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});
</script>
</body>
</html>
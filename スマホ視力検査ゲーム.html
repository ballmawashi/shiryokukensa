<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ランドルト環視力検査</title>
<style>
  body {
    font-family: 'Comic Sans MS', sans-serif;
    margin:0; padding:0;
    text-align:center;
    background: linear-gradient(135deg, #cce7ff, #f0f4f8);
  }
  h1 {
    font-size: 2.2em;
    text-shadow: 2px 2px 5px #888;
    margin: 20px 0;
    color:#ff6b81;
  }
  button {
    font-size: 1.3em;
    padding: 18px 28px;
    margin: 10px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    color: white;
    box-shadow: 0 5px 10px rgba(0,0,0,0.3);
    transition: all 0.2s ease;
  }
  button:hover, button:active {
    transform: translateY(-2px);
    box-shadow: 0 8px 12px rgba(0,0,0,0.4);
  }
  button.blue { background: #3b82f6; }
  button.green { background: #22c55e; }
  button.orange { background: #f97316; }

  #scoreBarContainer {
    width: 90%;
    height: 25px;
    background: #eee;
    margin: 15px auto;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: inset 0 0 5px #aaa;
  }
  #scoreBar {
    width:0%;
    height:100%;
    border-radius: 15px;
    transition: width 0.3s ease-in-out, background 0.3s ease-in-out;
  }

  #gameArea {
    display:none;
    width:90%;
    height:50vh;
    margin:10px auto;
    background:white;
    border-radius:15px;
    box-shadow:0 5px 15px rgba(0,0,0,0.3);
    position:relative;
    overflow:hidden;
  }

  #resultScreen, #rankingScreen {
    display:none;
    background: #fff8dc;
    padding: 15px;
    border-radius: 15px;
    margin: 10px auto;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }


  .landolt {
    margin: 20px auto;
    position: relative;
    display: inline-block;
  }

  .gap {
    position: absolute;
    background: white;
  }

  #backgroundCanvas {
    position: fixed;
    top: 0;
    left: 0;
    z-index: -1;
    pointer-events: none;
  }

  .direction-buttons {
    margin-top: 20px;
  }

  .direction-buttons button {
    margin: 5px;
    padding: 12px 20px;
    font-size: 1.1em;
  }


  .flash {
    animation: flash 0.3s ease-in-out;
  }

  @keyframes flash {
    0%, 100% { background-color: inherit; }
    50% { background-color: #ffff00; }
  }
</style>
</head>
<body>

<h1>ランドルト環視力検査</h1>

<div id="startScreen">
  <button class="blue" onclick="showRules()">視力検査を開始</button>
</div>

<div id="rulesScreen" style="display:none; background: #fff8dc; padding: 20px; border-radius: 15px; margin: 10px auto; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-width: 500px;">
  <h2>📱 視力検査の方法</h2>
  <div style="text-align: left; font-size: 1.1em; line-height: 1.6;">
    <p><strong>📏 距離の設定：</strong></p>
    <ul>
      <li>スマートフォンを目から <strong>30cm</strong> 離してください</li>
      <li>画面を垂直に保ち、明るい場所で測定してください</li>
    </ul>
    
    <p><strong>🎯 測定方法：</strong></p>
    <ul>
      <li>画面に表示される「C」の形（ランドルト環）の切れ目の方向を答えてください</li>
      <li>上下左右のボタンを押して回答します</li>
      <li>正解すると環が小さくなり、不正解だと大きくなります</li>
      <li>見えなくなるまで続けて、あなたの視力を測定します</li>
    </ul>
    
    <p><strong>⚠️ 注意事項：</strong></p>
    <ul>
      <li>片目ずつ測定することをおすすめします</li>
      <li>この結果は目安です。正確な視力は眼科で測定してください</li>
    </ul>
  </div>
  
  <button class="blue" onclick="startLandolt()" style="margin-top: 20px;">理解しました - 開始</button>
</div>

<div id="scoreBarContainer">
  <div id="scoreBar"></div>
</div>

<div id="gameArea">
  <div class="direction-buttons">
    <button class="blue" onclick="answer('up')">上</button><br>
    <button class="blue" onclick="answer('left')">左</button>
    <button class="blue" onclick="answer('right')">右</button><br>
    <button class="blue" onclick="answer('down')">下</button>
  </div>
</div>


<div id="resultScreen">
  <h2>結果</h2>
  <div id="resultText"></div>
  <button class="blue" onclick="saveAndShowRanking()">ランキングを見る</button>
  <button class="green" onclick="location.reload()">もう一度プレイ</button>
</div>

<div id="rankingScreen">
  <h2>ランキング</h2>
  <p id="rankingList"></p>
  <button onclick="location.reload()">トップに戻る</button>
</div>

<canvas id="backgroundCanvas"></canvas>

<script>
/* ===== 背景アニメーション ===== */
const canvas = document.getElementById('backgroundCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
let circles = [];
for(let i=0;i<30;i++){
  circles.push({
    x: Math.random()*canvas.width,
    y: Math.random()*canvas.height,
    r: Math.random()*20 + 5,
    dx: (Math.random()-0.5)*0.5,
    dy: (Math.random()-0.5)*0.5,
    alpha: Math.random()*0.5+0.3
  });
}
function animateBackground(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  circles.forEach(c=>{
    ctx.beginPath();
    ctx.arc(c.x, c.y, c.r, 0, Math.PI*2);
    ctx.fillStyle = `rgba(100,150,255,${c.alpha})`;
    ctx.fill();
    c.x += c.dx; c.y += c.dy;
    if(c.x<0||c.x>canvas.width) c.dx*=-1;
    if(c.y<0||c.y>canvas.height) c.dy*=-1;
  });
  requestAnimationFrame(animateBackground);
}
animateBackground();

/* ===== 効果音（ダミー関数） ===== */
function playSound(type) {
  // 効果音の代わりにコンソールログ
  console.log(`Playing ${type} sound`);
}

/* ===== 変数 ===== */
let size=100, minSize=4, currentDir, attempts=0, correctCount=0;
let gameMode = 'landolt';

/* ===== カウントダウン ===== */
function startCountdown(callback){
  let overlay = document.createElement('div');
  overlay.style.position = 'fixed';
  overlay.style.top = 0;
  overlay.style.left = 0;
  overlay.style.width = '100%';
  overlay.style.height = '100%';
  overlay.style.background = 'rgba(0,0,0,0.7)';
  overlay.style.display = 'flex';
  overlay.style.justifyContent = 'center';
  overlay.style.alignItems = 'center';
  overlay.style.zIndex = 9999;
  overlay.style.color = 'white';
  overlay.style.fontSize = '5em';
  document.body.appendChild(overlay);
  let count = 3;
  overlay.innerText = count;
  let timer = setInterval(()=>{
    count--;
    if(count > 0) overlay.innerText = count;
    else if(count === 0) overlay.innerText = "スタート！";
    else { clearInterval(timer); document.body.removeChild(overlay); callback(); }
  },1000);
}

/* ===== スコアバー ===== */
function updateScoreBar(){
  let percent = ((100-size)/96)*100;
  percent = Math.min(100, Math.max(0, percent));
  let bar = document.getElementById('scoreBar');
  bar.style.background='#3b82f6';
  bar.style.width = percent+'%';
}

function flashScoreBar() {
  let bar = document.getElementById('scoreBar');
  bar.classList.add('flash');
  setTimeout(() => bar.classList.remove('flash'), 300);
}

/* ===== ランキング ===== */
function saveScore(mode, score){
  let name = prompt("スコアを保存する名前を入力してください","名無し");
  if(!name) name="名無し";
  let key="ranking_"+mode;
  let ranking = JSON.parse(localStorage.getItem(key)||"[]");
  ranking.push({name,score});
  ranking.sort((a,b)=>b.score-a.score);
  ranking = ranking.slice(0,5);
  localStorage.setItem(key, JSON.stringify(ranking));
}

function showRanking(mode){
  document.getElementById('resultScreen').style.display='none';
  document.getElementById('rankingScreen').style.display='block';
  let key="ranking_"+mode;
  let ranking = JSON.parse(localStorage.getItem(key)||"[]");
  let html = ranking.map((r,i)=> `${i+1}位: ${r.name} - 視力${r.score}`).join("<br>");
  document.getElementById('rankingList').innerHTML = html||"まだ記録がありません";
}

function saveAndShowRanking() {
  let vision = calculateVision();
  saveScore('landolt', vision);
  showRanking('landolt');
}

function calculateScore() {
  return Math.max(0, 100 - size);
}

function calculateVision() {
  // 視力計算: サイズが小さいほど良い視力
  if(size <= 4) return 5.0;
  else if(size <= 6) return 3.0;
  else if(size <= 8) return 2.5;
  else if(size <= 10) return 2.0;
  else if(size <= 12) return 1.5;
  else if(size <= 16) return 1.2;
  else if(size <= 20) return 1.0;
  else if(size <= 25) return 0.9;
  else if(size <= 30) return 0.8;
  else if(size <= 40) return 0.7;
  else if(size <= 50) return 0.6;
  else if(size <= 60) return 0.5;
  else if(size <= 70) return 0.4;
  else if(size <= 80) return 0.3;
  else if(size <= 90) return 0.2;
  else return 0.1;
}

/* ===== ゲーム開始 ===== */
function showRules(){
  document.getElementById('startScreen').style.display='none';
  document.getElementById('rulesScreen').style.display='block';
}

function startLandolt(){
  document.getElementById('rulesScreen').style.display='none';
  startCountdown(()=>{
    document.getElementById('gameArea').style.display='block';
    size=100; correctCount=0; attempts=0;
    nextRound();
  });
}

/* ===== ランドルト環 ===== */
let directions = ["up","down","left","right"];

function drawLandolt(s, dir){
  let area = document.getElementById('gameArea');
  let existingLandolt = area.querySelector('.landolt');
  if(existingLandolt) existingLandolt.remove();
  
  // SVGでランドルト環を描画
  let svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.className = 'landolt';
  svg.setAttribute('width', s);
  svg.setAttribute('height', s);
  svg.style.margin = '20px auto';
  svg.style.display = 'block';
  
  let circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  circle.setAttribute('cx', s/2);
  circle.setAttribute('cy', s/2);
  circle.setAttribute('r', (s-20)/2);
  circle.setAttribute('fill', 'none');
  circle.setAttribute('stroke', 'black');
  circle.setAttribute('stroke-width', '10');
  
  // 切れ目を作るためのパス
  let gapSize = s/5; // 切れ目のサイズ
  let radius = (s-20)/2;
  let centerX = s/2;
  let centerY = s/2;
  
  let path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('fill', 'none');
  path.setAttribute('stroke', 'black');
  path.setAttribute('stroke-width', '10');
  path.setAttribute('stroke-linecap', 'butt');
  
  let pathData = '';
  
  if(dir === 'up') {
    // 上の切れ目
    let angle1 = -gapSize/radius;
    let angle2 = Math.PI * 2 + gapSize/radius;
    pathData = `M ${centerX + radius * Math.cos(angle1)} ${centerY + radius * Math.sin(angle1)} A ${radius} ${radius} 0 1 1 ${centerX + radius * Math.cos(angle2)} ${centerY + radius * Math.sin(angle2)}`;
  } else if(dir === 'down') {
    // 下の切れ目  
    let angle1 = Math.PI - gapSize/radius;
    let angle2 = Math.PI + gapSize/radius;
    pathData = `M ${centerX + radius * Math.cos(angle1)} ${centerY + radius * Math.sin(angle1)} A ${radius} ${radius} 0 1 1 ${centerX + radius * Math.cos(angle2)} ${centerY + radius * Math.sin(angle2)}`;
  } else if(dir === 'left') {
    // 左の切れ目
    let angle1 = Math.PI/2 + gapSize/radius;
    let angle2 = Math.PI*3/2 - gapSize/radius;
    pathData = `M ${centerX + radius * Math.cos(angle1)} ${centerY + radius * Math.sin(angle1)} A ${radius} ${radius} 0 1 1 ${centerX + radius * Math.cos(angle2)} ${centerY + radius * Math.sin(angle2)}`;
  } else if(dir === 'right') {
    // 右の切れ目
    let angle1 = -Math.PI/2 + gapSize/radius;
    let angle2 = Math.PI/2 - gapSize/radius;
    pathData = `M ${centerX + radius * Math.cos(angle1)} ${centerY + radius * Math.sin(angle1)} A ${radius} ${radius} 0 1 1 ${centerX + radius * Math.cos(angle2)} ${centerY + radius * Math.sin(angle2)}`;
  }
  
  path.setAttribute('d', pathData);
  
  svg.appendChild(path);
  area.insertBefore(svg, area.firstChild);
}

/* ===== ランドルト回答 ===== */
function answer(dir){
  attempts++;
  if(dir===currentDir){
    correctCount++;
    playSound('correct');
    flashScoreBar();
    size=Math.max(minSize,size-2);
  } else {
    playSound('wrong');
    size=Math.min(100,size+3);
  }
  updateScoreBar();
  if(size<=minSize||attempts>=30) endGame();
  else nextRound();
}

function nextRound(){
  currentDir = directions[Math.floor(Math.random()*4)];
  drawLandolt(size,currentDir);
  updateScoreBar();
}


/* ===== 結果 ===== */
function endGame(){
  document.getElementById('gameArea').style.display='none';
  document.getElementById('resultScreen').style.display='block';
  
  let vision = calculateVision();
  let score = calculateScore();
  let result;
  
  if(vision >= 2.0) result = `視力${vision}！素晴らしい視力です！`;
  else if(vision >= 1.0) result = `視力${vision}！良好な視力です！`;
  else if(vision >= 0.7) result = `視力${vision}。日常生活に支障はありません。`;
  else if(vision >= 0.3) result = `視力${vision}。やや注意が必要です。`;
  else result = `視力${vision}。眼科受診をおすすめします。`;
  
  document.getElementById('resultText').innerHTML = 
    `<h3>測定結果</h3><p style="font-size:1.5em;color:#ff6b81;"><strong>${result}</strong></p><p>スコア: ${score}点</p><p>正解数: ${correctCount}回 / ${attempts}回</p><p><small>※この結果は目安です。正確な視力は眼科で測定してください。</small></p>`;
}


// ウィンドウリサイズ時にキャンバスサイズを調整
window.addEventListener('resize', function() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});
</script>
</body>
</html>